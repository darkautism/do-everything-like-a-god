name: Build and Deploy WASM Tools

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install Trunk
        run: cargo install trunk

      - name: Build with Trunk
        run: trunk build --release --public-url /do-everything-like-a-god/

      - name: Post-build SEO Optimization
        working-directory: dist
        run: |
          declare -A titles
          declare -A descriptions
          
          titles["base64"]="Base64 Encoder/Decoder"
          descriptions["base64"]="Online Base64 encoder and decoder tool."
          
          titles["base32"]="Base32 Encoder"
          descriptions["base32"]="Online Base32 encoding tool."
          
          titles["base58"]="Base58 Encoder"
          descriptions["base58"]="Online Base58 encoding tool."
          
          titles["html-escape"]="HTML Entity Encoder"
          descriptions["html-escape"]="Online HTML escape tool for special characters."
          
          titles["url-escape"]="URL Encoder"
          descriptions["url-escape"]="Online URL encoding and decoding tool."
          
          titles["json"]="JSON Formatter"
          descriptions["json"]="Online JSON formatter, validator, and minifier."
          
          titles["hash"]="Hash Generator"
          descriptions["hash"]="Online hash generator with MD5, SHA-1, SHA-256, etc."
          
          titles["aes"]="AES Encryption"
          descriptions["aes"]="Online AES encryption and decryption tool."
          
          titles["jwt"]="JWT Decoder"
          descriptions["jwt"]="Online JWT decoder tool."
          
          titles["uuid"]="UUID Generator"
          descriptions["uuid"]="Online UUID generator tool."
          
          titles["regex"]="Regex Tester"
          descriptions["regex"]="Online regular expression tester."
          
          titles["timestamp"]="Timestamp Converter"
          descriptions["timestamp"]="Online Unix timestamp converter."
          
          titles["base-conv"]="Base Converter"
          descriptions["base-conv"]="Online number base converter."
          
          titles["diff"]="Diff Checker"
          descriptions["diff"]="Online text difference comparison tool."
          
          titles["cron"]="Cron Expression Parser"
          descriptions["cron"]="Online cron expression parser."
          
          titles["image-base64"]="Image to Base64"
          descriptions["image-base64"]="Online image to Base64 converter."
          
          echo "Starting directory creation..."
          for dir in base64 html-escape url-escape json hash jwt uuid regex timestamp base-conv diff cron image-base64; do
            mkdir -p "$dir"
            cp index.html "$dir/index.html"
            
            title="${titles[$dir]}"
            desc="${descriptions[$dir]}"
            
            perl -i -pe "s|<title>.*</title>|<title>\$title</title>|g" "$dir/index.html"
            perl -i -pe "s|<meta name=\"title\" content=\"[^\"]*\"|<meta name=\"title\" content=\"\$title\"|g" "$dir/index.html"
            perl -i -pe "s|<meta name=\"description\" content=\"[^\"]*\"|<meta name=\"description\" content=\"\$desc\"|g" "$dir/index.html"
            perl -i -pe "s|<meta property=\"og:title\" content=\"[^\"]*\"|<meta property=\"og:title\" content=\"\$title\"|g" "$dir/index.html"
            perl -i -pe "s|<meta property=\"og:description\" content=\"[^\"]*\"|<meta property=\"og:description\" content=\"\$desc\"|g" "$dir/index.html"
            perl -i -pe "s|<meta property=\"twitter:title\" content=\"[^\"]*\"|<meta property=\"twitter:title\" content=\"\$title\"|g" "$dir/index.html"
            perl -i -pe "s|<meta property=\"twitter:description\" content=\"[^\"]*\"|<meta property=\"twitter:description\" content=\"\$desc\"|g" "$dir/index.html"
            
            echo "Created $dir/index.html with SEO"
          done
          
          cp ../public/sitemap.xml ./
          cp ../public/robots.txt ./
          
          echo "DIST CONTENTS:"
          find . -maxdepth 2

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
